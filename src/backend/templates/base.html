<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Transcendence</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

  </head>
  <style>
	{% comment %} body {
	  background-color: #333;
	  color: white;
	} {% endcomment %}
	</style>
  <body>

	{% include "navbar.html" %}
	
    <main id="oldContent">
		{% block content %}{% endblock content %}
    </main>
	
	<div id="chatRoom">

		{% include "chatroom.html" %}

	</div>

	<script>	
	
		function updateContent(path) {
			fetch(path)
			.then(response => {
				if (!response.ok) {
				  if (response.status === 401) {
					updateContent("/login/");
				  } else if (response.status === 403) {
					updateContent("/login/");
				  } else {
					throw new Error("Unexpected Error");
				  }
				}
				return response.text();
			  })
			  .then(html => {
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, "text/html");
				const newContent = doc.querySelector("#newContent"); 
				const oldContent = document.getElementById("oldContent");
				oldContent.innerHTML = ""; 
				oldContent.appendChild(newContent);
				reattachEventListeners();
			  })
			  .catch(error => console.error('Error fetching content:', error));
		  };
		

		function handleRoute(event, path) {
			event.preventDefault();
			if (window.location.pathname !== path) {
				window.history.pushState({path: path}, '', path);
				updateContent(path);
			}
		}

		function reattachEventListeners(){
			loginButton()
			login()
			logout()
			generateQRCode()
			validateOTP()
			oauth()
			profileButton()
			saveChanges()
			homeButton()
			defaultButton()
			soloGame()
			multiplayerGame()
		}


		async function getUsernameFromBackend(token) {
			try {
				const response = await fetch("/api/get_username", {
					method: "GET",
					headers: {
						"Authorization": `Bearer ${token}`,
					}
				});
				if (response.ok) {
					const userData = await response.json();
					const username = userData.username;
					return username;
				} else {
					throw new Error("Failed to get username from backend");
				}
			} catch (error) {
				console.error("Error getting username from backend:", error);
				throw error;
			}
		}
		

		async function checkAccessToken() {
			const token = localStorage.getItem("access_token");
			if (token) {
				try {
					const response = await fetch("/token/verify/", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							"Authorization": `Bearer ${token}`,
						},
						body: JSON.stringify({ token: token }),
					});
					if (response.ok) {
						const username = await getUsernameFromBackend(token);
						showLoggedInState(username);
					} else {
						showLoggedOutState();
					}
				} catch (error) {
					console.error("Error verifying token:", error);
					showLoggedOutState();
				}
			} else {
				showLoggedOutState();
			}
		};


		document.addEventListener("DOMContentLoaded", checkAccessToken);



			const showLoggedInState = (username) => {
				navButtons.innerHTML = `
				<button class="nav-button" id="defaultPage">Transcendence</button>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				  <span class="navbar-toggler-icon"></span>
				</button>
				<li class="nav-item">
					<button class="nav-button" id="game" >Solo Game</button>
				</li>

					<li class="nav-item dropdown">
						<button class="nav-button dropdown-toggle" id="friendsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
							Friends
						</button>
						<ul class="dropdown-menu" aria-labelledby="friendsDropdown">
							<li>
								<input type="text" id="search-friends" class="form-control" placeholder="Search user...">
							</li>
							<li id="search-results"></li>
							<div id="friend-requests"></div>
							<div class="dropdown-divider"></div>
							<h5 class="dropdown-header">Friends</h5>
							<div id="friends-list"></div>
						</ul>
					</li>
					<li class="nav-item">
						<button class="nav-button" id="multiplayerGame" >Play Multiplayer</button>
					</li>
					<li class="nav-item dropdown">
						<button class="nav-button dropdown-toggle" id="navbarDropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
							${username}
						</button>
						<ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
							<li><button class="dropdown-item" id="profile" >View Profile</button></li>
							<li><hr class="dropdown-divider"></li>
							<li><button class="dropdown-item" id="logout">Logout</button></li>
						</ul>
					</li>
				`;
				reattachEventListeners();
			};
		
			// Function to display UI for logged-out state
			const showLoggedOutState = () => {
				navButtons.innerHTML = `
				<button class="nav-button" id="defaultPage">Transcendence</button>
				<li class="nav-item">
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
				</li>
				<li class="nav-item">
					<button class="nav-button login-button" id="login">Login</button>
				</li>
				<li class="nav-item">
					<button class="nav-button" id="register" >Authenticate with 42</button>
				</li>
			`;
				reattachEventListeners();
			};

			
		function soloGame(){
			const soloGameButton = document.getElementById("game");
			if (soloGameButton) {
				soloGameButton.addEventListener("click", function(event) {
					event.preventDefault();
					handleRoute(event, "/game/");
				});
			}
		}

		function multiplayerGame(){
			const multiplayerGame = document.getElementById("multiplayerGame");
			if (multiplayerGame) {
				multiplayerGame.addEventListener("click", function(event) {
					event.preventDefault();
					handleRoute(event, "/multiplayer/");
				});
			}
		}

		function loginButton(){
			const loginButton = document.getElementById("login");
			if(loginButton){
				loginButton.addEventListener("click", function(event) {
					event.preventDefault();
					handleRoute(event, "/login/");
			});	
		}
	}


		function defaultButton(){
			const defaultButton = document.getElementById("defaultButton");
			if(defaultButton){
				defaultButton.addEventListener("click", function(event) {
					event.preventDefault();
					window.history.pushState({ path: '' }, '', '');
					updateContent("");
			});
		}
	}


		function homeButton(){
			const homeButton = document.getElementById("homeButton");
			if(homeButton){
				homeButton.addEventListener("click", function(event) {
					event.preventDefault();
					window.history.pushState({ path: '/home/' }, '', '/home/');
					updateContent("/home/");
			});
		}
	}

		function updateProfile() {
				fetch('/api/get_profile/', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				})
				.then(response => {
					console.log('Raw Response Status:', response.status);
					return response.text();
				})
				.then(rawData => {
					console.log('Raw Response Data:', rawData);
					try {
						const data = JSON.parse(rawData);
						if (data) {
							document.getElementById('profile-name').textContent = data.username;
							document.getElementById('profile-username').value = data.username;
							document.getElementById('profile-email').value = data.email;
							document.getElementById('profile-display_name').value = data.display_name;
							document.getElementById('profile-picture_url').value = data.picture_url;
							const profilePictureUrl = data.profile_picture;
							console.log(data.profile_picture);
							if (profilePictureUrl) {
								console.log(profilePictureUrl);
								const profilePicture = document.getElementById('profile-picture');
								profilePicture.setAttribute('src', profilePictureUrl);
							}
						}
					} catch (error) {
						console.error('Error parsing JSON:', error);
					}
				})
				.catch(error => {
					console.error('Error fetching profile data:', error);
				});
			}
		
		async function saveChanges() {
			const saveChangesButton = document.getElementById("saveChangesButton");
			if (saveChangesButton) {
				saveChangesButton.addEventListener("click", async function(event) {
					event.preventDefault();
					const picture_url = document.getElementById("profile-picture_url").value;
					const display_name = document.getElementById("profile-display_name").value;
					const csrftoken = getCookie("csrftoken")
					try {
						const response = await fetch("/api/save_changes/", {
							method: "PUT",
							headers: {
								"Content-Type": "application/json",
								"X-CSRFToken": csrftoken,
							},
							body: JSON.stringify({ display_name: display_name, picture_url: picture_url })
						});
						if (!response.ok) {
							const errorData = await response.json();
							alert(errorData.error);
						} else {
							alert("Settings got changed");
							updateProfile();
						}
					} catch (error) {
						console.error("Something went wrong:", error);
					}
				});
			}
		}

		function profileButton() {
			const profileButton = document.getElementById("profile");
			if (profileButton) {
				profileButton.addEventListener("click", function(event) {
					event.preventDefault();
					handleRoute(event, "/profile/");
					fetch('/api/get_profile/', {
						method: 'GET',
						headers: {
							'Content-Type': 'application/json'
						}
					})
					.then(response => {
						console.log('Raw Response Status:', response.status);
						return response.text();
					})
					.then(rawData => {
						console.log('Raw Response Data:', rawData);
						try {
							const data = JSON.parse(rawData);
							if (data) {
								document.getElementById('profile-name').textContent = data.username;
								document.getElementById('profile-username').value = data.username;
								document.getElementById('profile-email').value = data.email;
								document.getElementById('profile-display_name').value = data.display_name;
								document.getElementById('profile-picture_url').value = data.picture_url;
								const profilePictureUrl = data.profile_picture;
								console.log(data.profile_picture);
								if (profilePictureUrl) {
									console.log(profilePictureUrl);
									const profilePicture = document.getElementById('profile-picture');
									profilePicture.setAttribute('src', profilePictureUrl);
								}
							}
						} catch (error) {
							console.error('Error parsing JSON:', error);
						}
					})
					.catch(error => {
						console.error('Error fetching profile data:', error);
					});
				});
			}
		}
		


	document.addEventListener('DOMContentLoaded', function() {
		const currentUrl = window.location.href;
		console.log(currentUrl);
		if (currentUrl.includes('profile')) {
			fetch('/api/get_profile/', {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(response => {
				console.log('Raw Response Status:', response.status);
				return response.text();
			})
			.then(rawData => {
				console.log('Raw Response Data:', rawData);
				try {
					const data = JSON.parse(rawData);
					if (data) {
						document.getElementById('profile-name').textContent = data.username;
						document.getElementById('profile-username').value = data.username;
						document.getElementById('profile-email').value = data.email;
						document.getElementById('profile-display_name').value = data.display_name;
						document.getElementById('profile-picture_url').value = data.picture_url;
						const profilePictureUrl = data.profile_picture;
						console.log(data.profile_picture);
						if (profilePictureUrl) {
							console.log(profilePictureUrl);
							const profilePicture = document.getElementById('profile-picture');
							profilePicture.setAttribute('src', profilePictureUrl);
						}
					}
				} catch (error) {
					console.error('Error parsing JSON:', error);
				}
			})
			.catch(error => {
				console.error('Error fetching profile data:', error);
			});
		}
	});






		function set_passwd(){
			const passwd = document.getElementById("passwordForm");
			if (passwd) {
				passwd.addEventListener("click", async function(event){
					event.preventDefault();
					const password = document.getElementById('password').value;
					const confirmPassword = document.getElementById('confirmPassword').value;

					if(password !== confirmPassword){
						alert("Passwords do not match! Try again!")
					}
					else{
						const csrftoken = getCookie("csrftoken")
						try{
							const response = await fetch("/api/set_passwd/", {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
									"X-CSRFToken": csrftoken,
									'Cache-Control': 'no-cache'
								},
								body: JSON.stringify({password:confirmPassword})
							});
							if(!response.ok){
								alert(response.error);
							}
							alert("Setting your passwd was successful!")
							window.history.pushState({ path: '/login/' }, '', '/login/');
							updateContent("/login/");
						}
						catch(error) {
							console.error("something went wrong");
						}
					}
				});
			}
		}

			window.onload = function(){
				const registration = document.getElementById("passwordForm");
				if (registration) {
					const currentUrl = window.location.href;
					if (currentUrl.includes('/set_')) {
							fetch("/api/fetch_user_data/")
								.then(response => response.json())
								.then(data => {
									if (data.error) {
										alert("Already logged in");
										window.history.pushState({ path: '/login/' }, '', '/login/');
										updateContent("/login/");
									}
									console.log("Getting User data successful");
								})
								.catch(error => {
									console.error('Error during fetch:', error);
								});
						}
					}
			}

		function oauth() {
			const registerButton = document.getElementById("register");
			if (registerButton) {
				registerButton.addEventListener("click", () => {
					fetch("/api/oauth/")
						.then(response => {
							if (!response.ok) {
								return response.text().then(text => {
									throw new Error(`Network response was not ok: ${response.statusText}\n${text}`);
								});
							}
							return response.json();
						})
						.then(data => {
							window.location.href = data.url;
						})
						.catch(error => {
							console.error('Error during fetch:', error);
						});
				});
			}
		}

		function logout() {
			const logoutButton = document.getElementById("logout");
			if (logoutButton) {
				logoutButton.addEventListener("click", async function(event) {
					event.preventDefault();
					const refreshToken = localStorage.getItem("refresh_token");
					const csrftoken = getCookie("csrftoken");
					try {
						const response = await fetch("/api/logout/", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								"X-CSRFToken": csrftoken,
								'Cache-Control': 'no-cache'
							},
							body: JSON.stringify({ refresh_token: refreshToken })
						});
						if (!response.ok)
							throw new Error("Logout fail");
						localStorage.removeItem('access_token');
						localStorage.removeItem('refresh_token');
						setLoginStatus('false');
						window.history.pushState({ path: '/login/' }, '', '/login/');
						updateContent("/login/");
				
					} catch (error) {
						console.log("Error in logout", error);
					}
				});
			}
		}

		function login() {
			const Login = document.getElementById("loginFormContent");
			if (Login) {
				Login.addEventListener("submit", async function(event) {
					event.preventDefault();
					const username = document.getElementById("username").value;
					const password = document.getElementById("password").value;
					const csrftoken = getCookie("csrftoken");
	
					try {
						const response = await fetch("/api/login/", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								"X-CSRFToken": csrftoken,
								'Cache-Control': 'no-cache'
							},
							body: JSON.stringify({ username, password }),
						});
						if (!response.ok) 
							throw new Error("Login failed");
						
						const twoFAResponse = await fetch("/api/get_2fa_status/", {
							method: "GET",
							headers: {
								"Content-Type": "application/json",
								"X-CSRFToken": csrftoken,
								'Cache-Control': 'no-cache'
							},
						});
						if (!twoFAResponse.ok)
							throw new Error("Getting 2FA status failed");
						const twoFAResponseData = await twoFAResponse.json();
						if (twoFAResponseData.enable === true) {
							window.history.pushState({ path: '/2FA/' }, '', '/2FA/');
							updateContent("/2FA/");
							await getAccessToken(username, password, csrftoken);
						}
						else{
							console.log("there");
							await getAccessToken(username, password, csrftoken);
							setLoginStatus('true');
							window.history.pushState({ path: '/home/' }, '', '/home/');
							updateContent("/home/");
							checkAccessToken();
						}
					} catch(error) {
						console.error("Login error:", error);
						alert("Login failed. Please try again.");
					}
				});
			}
		}



		
        function validateOTP() {
            const validateButton = document.getElementById("validateOTP");
            if (validateButton) {
                validateButton.addEventListener("click", function(event) {
                    event.preventDefault();
                    const otp = document.getElementById("otpInput").value;
					const csrftoken = getCookie("csrftoken");
                    fetch("/api/validateOTP/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
							"X-CSRFToken": csrftoken,
							'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({otp: otp })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.valid) {
							window.history.pushState({ path: '/home/' }, '', '/home/');
							updateContent("/home/");
                        } else {
                            alert("Validation failed: Invalid OTP");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("An error occurred while validating the OTP");
                    });
                });
            }
        }


		function generateQRCode() {
			const qrcodeButton = document.getElementById("generateQRCode");
			if (qrcodeButton) {
				qrcodeButton.addEventListener("click", function(event) {
					event.preventDefault();
					fetch("/api/setup-2fa", {
						method: "GET",
						headers: {
							"Content-Type": "application/json",
							'Cache-Control': 'no-cache'
						}
					})
					.then(response => {
						if (!response.ok) {
							throw new Error("Network response was not ok");
						}
						return response.text();
					})
					.then(responseText => {
						const data = JSON.parse(responseText);
						const qrCodeImg = document.getElementById("qrcode");
						qrCodeImg.src = "data:image/png;base64," + data.qr_code;
					})
					.catch(error => {
						console.log("Error:", error);
					});
				});
			}
		}
		


		window.addEventListener('popstate', function(event) {
			if (event.state && event.state.path) {
				updateContent(event.state.path);
			}
		});


		
//need to call the logout endpoint

	document.addEventListener("DOMContentLoaded", function() {
		reattachEventListeners();
	});


	function checkJWTToken(){
		const access_token = localStorage.getItem('access_token')
		if (access_token === null && isLoggedIn()){
			setLoginStatus('false')
			window.history.pushState({ path: '/home/' }, '', '/home/');
			updateContent("/home/");
		}

	}

	function setLoginStatus(status){
		localStorage.setItem('loginStatus', status);
	}

	function isLoggedIn(){
		const loggedIn = localStorage.getItem('loginStatus');
		return loggedIn === 'true';
	}

	setInterval(checkJWTToken, 5000);
		

	function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function getAccessToken(username, password, csrftoken) {
        try {
            const response = await fetch("/token/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
					'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({ username, password }),
            });

            if (!response.ok) {
                throw new Error("Token failed");
            }
            const data = await response.json();
            localStorage.setItem("access_token", data.access);
            localStorage.setItem("refresh_token", data.refresh);
        } catch (error) {
            console.error("Token error:", error);
            alert("Token");
        }
    }
//test if refresh token is null
    async function refreshToken() {
        const refreshToken = localStorage.getItem("refresh_token");
        try {
            const response = await fetch("/token/refresh/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
					'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({ refresh: refreshToken }),
            });

            if (!response.ok) {
                throw new Error("Token refresh failed");
            }
            const data = await response.json();
            localStorage.setItem("access_token", data.access);
        } catch (error) {
            console.error("Token refresh error:", error);
            alert("Token refresh failed. Please login again.");
			window.history.pushState({ path: '/home/' }, '', '/home/');
			updateContent("/home/");
		}
    }

	function setLoginStatus(status){
		localStorage.setItem('loginStatus', status);
	}
	//check if token is null, protect routes in backend if there is no token anymore
	function isLoggedIn(){
		const loggedIn = localStorage.getItem('loginStatus');
		return 
	}
	</script>
	</body>
	</html>
	
	
