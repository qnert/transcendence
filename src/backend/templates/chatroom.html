
{% block chat %}


<style>
	
  
  </style>
  
  <input type="checkbox" id="check">
  <label class="chat-btn" for="check">
	  <i class="fa fa-commenting-o comment"></i>
	  <i class="fa fa-close close"></i>
  </label>
	<div class="wrapper" id="friendsList">
	  <div class="header">
		  <h6>Message a Friend</h6>
	  </div>
	  <div class="chat-form">
		  <ul class="friend-list" id="friendList">
			  {% comment %} Friend list items will be dynamically inserted here {% endcomment %}
		  </ul>
	  </div>
	</div>
  
	<div class="wrapper" id="chatRoom" style="display: none;">
		<div class="header">
			<h6 id="chat-header">Chat with <span id="friend-name"></span></h6>
		</div>
		<div class="chat-form">
			<textarea class="form-control" id="chat-text" rows="5" readonly></textarea>
			<input type="text" class="form-control chat-text" id="message" placeholder="Your Message">
			<button class="btn-chat btn-success btn-block" id="send">Send</button>
			<button class="btn-chat btn-success btn-block" id="leave">Back</button>
		</div>
	</div>
  
  {% comment %} <script>
	document.addEventListener("DOMContentLoaded", function() {
	  let chatSocket;
	  let selectedFriendId = null;
  
	  function loadFriends() {
		// Fetch the list of friends from the server (replace with your actual endpoint)
		fetch('/api/friends/')
		  .then(response => response.json())
		  .then(data => {
			const friendList = document.getElementById('friendList');
			friendList.innerHTML = ''; // Clear the list
			data.forEach(friend => {
			  const li = document.createElement('li');
			  li.id = `friend-${friend.user_id}`;
			  li.dataset.friendId = friend.user_id;
  
			  const img = document.createElement('img');
			  img.src = friend.profile_picture_url;
			  img.alt = friend.display_name;
  
			  const statusText = document.createElement('span');
			  statusText.id = `chat-status-${friend.user_id}`;
			  statusText.className = 'status-text ' + (friend.is_online ? 'online' : 'offline');
			  statusText.textContent = friend.is_online ? 'online' : 'offline';
  
			  const friendDetails = document.createElement('div');
			  friendDetails.className = 'friend-details';
			  friendDetails.appendChild(img);
			  friendDetails.appendChild(statusText);
  
			  const friendInfo = document.createElement('div');
			  friendInfo.className = 'friend-info';
  
			  const nameAndButtons = document.createElement('div');
			  nameAndButtons.className = 'name-and-buttons';
  
			  const span_name = document.createElement('span');
			  span_name.textContent = friend.display_name;
  
			  const messageButton = document.createElement('button');
			  messageButton.textContent = 'Message';
			  messageButton.onclick = () => selectFriend(friend.user_id, friend.display_name);
  
			  const blockButton = document.createElement('button');
			  blockButton.textContent = 'Block';
			  blockButton.onclick = () => blockUser(friend.user_id);
  
			  const unblockButton = document.createElement('button');
			  unblockButton.textContent = 'Unblock';
			  unblockButton.onclick = () => unblockUser(friend.user_id);
			  unblockButton.style.display = 'none'; // Hide the unblock button initially
  
			  if (friend.is_blocked) {
				messageButton.style.display = 'none';
				blockButton.style.display = 'none';
				statusText.style.display = 'none';
				unblockButton.style.display = 'inline';
			  }
  
			  if (friend.blocked_by)
				statusText.style.display = 'none';
  
			  nameAndButtons.appendChild(span_name);
			  nameAndButtons.appendChild(messageButton);
			  nameAndButtons.appendChild(blockButton);
			  nameAndButtons.appendChild(unblockButton);
  
			  friendInfo.appendChild(nameAndButtons);
  
			  li.appendChild(friendDetails);
			  li.appendChild(friendInfo);
			  friendList.appendChild(li);
			});
		  });
	  }
  
	  function selectFriend(friendId, friendName) {
		selectedFriendId = friendId;
		document.getElementById('friend-name').textContent = friendName;
		document.getElementById('chatRoom').style.display = 'block';
		document.getElementById('friendsList').style.display = 'none';
		document.getElementById('message').disabled = false;
		document.getElementById('send').disabled = false;
		loadMessages(friendId);
		initializeWebSocket(friendId);
	  }
  
	  function loadMessages(friendId) {
		// Fetch the chat messages from the server (replace with your actual endpoint)
		fetch(`/api/messages/${friendId}/`)
			.then(response => response.json())
			.then(data => {
				// Check if the response contains messages
				if (data.messages && Array.isArray(data.messages)) {
					const messageList = document.getElementById('chat-text');
					messageList.innerHTML = ''; // Clear the list
					data.messages.forEach(message => {
						document.querySelector('#chat-text').value += (message.sender + ': ' + message.content + '\n');
					});
				} else {
					console.error('Unexpected response format:', data);
				}
			})
			.catch(error => console.error('Error loading messages:', error));
		}
  
	  function initializeWebSocket(friendId) {
		if (chatSocket) {
		  chatSocket.close();
		}
  
		const userId = {{ request.user.id }};
		chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${userId}/${friendId}/`);
  
		chatSocket.onmessage = function(e) {
		  const data = JSON.parse(e.data);
		  const chatText = document.getElementById('chat-text');
		  chatText.value += `${data.sender}: ${data.message}\n`;
		};
  
		chatSocket.onclose = function(e) {
		  console.error('Chat socket closed');
		};
	  }
  
	  document.getElementById('send').onclick = sendMessage;
	  document.getElementById('message').addEventListener('keypress', function(e) {
		if (e.key === 'Enter') {
		  sendMessage();
		}
	  });
  
	  function sendMessage() {
		const messageInput = document.getElementById('message');
		const message = messageInput.value.trim();
		if (message && chatSocket.readyState === WebSocket.OPEN) {
		  chatSocket.send(JSON.stringify({
			'message': message,
			'friend_id': selectedFriendId
		  }));
		  messageInput.value = '';
		}
	  }
  
	  document.getElementById('leave').onclick = function() {
		if (chatSocket) {
		  chatSocket.close();
		}
		document.getElementById('chatRoom').style.display = 'none';
		document.getElementById('friendsList').style.display = 'block';
		document.getElementById('message').disabled = true;
		document.getElementById('send').disabled = true;
		document.getElementById('chat-text').value = '';
		document.getElementById('message').value = '';
	  };
  
	  function blockUser(userId) {
		fetch(`/api/block/${userId}/`, {
		  method: 'POST',
		  headers: {
			'Content-Type': 'application/json',
			'X-CSRFToken': '{{ csrf_token }}'
		  },
		  body: JSON.stringify({})
		})
		  .then(response => response.json())
		  .then(data => {
			updateFriendDropdown();
			loadFriends(); // Reload the friend list to update the button states
		  });
	  }
  
	  function unblockUser(userId) {
		fetch(`/api/unblock/${userId}/`, {
		  method: 'POST',
		  headers: {
			'Content-Type': 'application/json',
			'X-CSRFToken': '{{ csrf_token }}'
		  },
		  body: JSON.stringify({})
		})
		  .then(response => response.json())
		  .then(data => {
			updateFriendDropdown();
			loadFriends(); // Reload the friend list to update the button states
		  });
	  }
  
	  loadFriends();
	});

  </script> {% endcomment %}
  
  
{% endblock chat %}
